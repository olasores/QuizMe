# Trending Topics Feature Implementation Guide

## Overview
This implementation adds Claude AI-powered quiz generation for trending topics. When users click on a topic in the dashboard, a quiz is automatically generated using the Anthropic Claude API.

## Components Created/Modified

### 1. API Endpoint: `/pages/api/generate-trending-quiz.ts`
**Purpose**: Generates quiz questions using Claude AI based on a topic

**How it works**:
- Receives a topic name and number of questions from the frontend
- Uses Claude 3.5 Sonnet model to generate structured quiz questions
- Saves the generated quiz to the Supabase database
- Tracks trending topic usage in the database

**Request Body**:
```json
{
  "topic": "React",
  "numQuestions": 10
}
```

**Response**:
```json
{
  "success": true,
  "quiz": {
    "title": "Quiz title generated by Claude",
    "description": "Description of the quiz",
    "questions": [...]
  }
}
```

### 2. Updated Component: `TrendingTopics.tsx`
**Features**:
- Click handlers on topic buttons
- Loading states with spinner animation
- Error handling and display
- Redirects to quiz page after successful generation

**Key Functions**:
- `handleTopicClick()`: Calls the API and handles the response
- Loading indicator while generating quiz
- Error messages displayed to user

### 3. Database Schema Update: `supabase/schema.sql`
**New Table**: `trending_topic_usage`
- Tracks which topics are being used for quiz generation
- Stores the quiz ID and timestamp
- Useful for analytics and trending topic calculations

## Setup Instructions

### 1. Update Your Environment Variables
Make sure you have `ANTHROPIC_API_KEY` in your `.env.local`:
```
ANTHROPIC_API_KEY=sk-ant-api03-your-key-here
```

### 2. Run Database Migration
Run the updated schema.sql against your Supabase database to create the `trending_topic_usage` table:
```bash
# Using Supabase CLI
supabase db push

# Or manually paste the new table creation in Supabase SQL editor
```

### 3. Verify Quizzes Table Schema
Make sure your `quizzes` table has the necessary columns (it should already):
```sql
- id
- title
- description
- topic
- source_type
- source_name
- questions_count
- created_at
- updated_at
```

## How It Works (User Flow)

1. **User clicks a trending topic** on the dashboard
2. **Loading spinner appears** on the button
3. **Frontend sends POST request** to `/api/generate-trending-quiz`
4. **Backend calls Claude API** with the topic
5. **Claude generates quiz questions** in JSON format
6. **Quiz saved to database** (quizzes + questions tables)
7. **Usage tracked** in trending_topic_usage table
8. **User redirected** to the quiz page to start taking the quiz

## Example: Topic = "React"

Claude will generate a response like:
```json
{
  "title": "React Fundamentals Quiz",
  "description": "Test your knowledge of React basics and concepts",
  "questions": [
    {
      "question": "What is React?",
      "options": ["A UI library", "A backend framework", "A database", "A design tool"],
      "correctAnswer": 0
    },
    ...
  ]
}
```

## Customization Options

### 1. Change Number of Questions
In `TrendingTopics.tsx`, modify the API call:
```typescript
body: JSON.stringify({
  topic: topic,
  numQuestions: 15,  // Change from 10 to 15
}),
```

### 2. Add More Topics
In `TrendingTopics.tsx`:
```typescript
const topics = [
  'JavaScript',
  'React',
  'Next.js',
  'CSS',
  'Databases',
  'APIs',
  'TypeScript',
  'Algorithms',
  'Python',  // Add new topic
  'GraphQL', // Add new topic
];
```

### 3. Change Claude Model
In `/pages/api/generate-trending-quiz.ts`:
```typescript
const message = await anthropic.messages.create({
  model: 'claude-3-opus-20240229', // Change to different model
  max_tokens: 4000,
  messages: [...],
});
```

### 4. Redirect to Different Page
In `TrendingTopics.tsx`:
```typescript
// Instead of /quiz?topic=...
router.push(`/dashboard/topic/${encodeURIComponent(topic)}`);
```

## Error Handling

The implementation includes error handling for:
- Missing API key
- Invalid Claude response
- Database save failures
- Network errors

Errors are displayed to the user in a red banner below the topics.

## Database Queries for Analytics

Get most used trending topics:
```sql
SELECT topic, COUNT(*) as usage_count
FROM trending_topic_usage
WHERE used_at > NOW() - INTERVAL '7 days'
GROUP BY topic
ORDER BY usage_count DESC
LIMIT 10;
```

## Next Steps (Optional Enhancements)

1. **Cache generated quizzes** to avoid regenerating the same topic
2. **Add user personalization** based on their quiz history
3. **Create trending topics page** showing all topics with stats
4. **Add difficulty selector** (easy, medium, hard)
5. **Track user performance** on AI-generated quizzes
6. **Add topic recommendations** based on user interests

## Troubleshooting

**Issue**: "Missing ANTHROPIC_API_KEY"
- Solution: Verify API key is in .env.local and server is restarted

**Issue**: Claude returns invalid JSON
- Solution: Check the prompt format, Claude sometimes needs clearer instructions

**Issue**: Quiz not saving to database
- Solution: Check that SUPABASE_SERVICE_ROLE is set in environment variables

**Issue**: Redirect not working
- Solution: Ensure `/quiz` page exists, or update redirect path accordingly

## Files Modified/Created
- ✅ `/pages/api/generate-trending-quiz.ts` (Created)
- ✅ `/src/components/dashboard/TrendingTopics.tsx` (Updated)
- ✅ `/supabase/schema.sql` (Updated)
